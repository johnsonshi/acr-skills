# ACR Vulnerability Scanning Skill

This skill provides comprehensive knowledge about Azure Container Registry vulnerability scanning.

## When to Use This Skill

Use this skill when answering questions about:
- Microsoft Defender scanning
- Vulnerability detection
- Security findings
- Remediation

## Scanning Options

| Option | Provider | Automation |
|--------|----------|------------|
| Microsoft Defender for Cloud | Azure | Push-based |
| Continuous Patching | Trivy + Copa | Scheduled |
| Image Quarantine | External scanners | Custom |

## Microsoft Defender for Cloud

### Enable Defender
```bash
# Enable Defender for Containers
az security pricing create \
  --name Containers \
  --tier Standard
```

### How It Works
1. **On Push**: Automatically scans images pushed to registry
2. **On Import**: Scans imported images
3. **Recent Pulls**: Scans images pulled within last 30 days
4. **Continuous**: Re-scans for new vulnerabilities

### View Findings
- Azure Portal → Defender for Cloud → Recommendations
- Security Center API
- Azure Resource Graph

### Network-Restricted Registries
Enable trusted services for Defender access:
```bash
az acr update --name myregistry --allow-trusted-services true
```

## Continuous Patching

Automated OS-level vulnerability remediation:

```bash
# Install extension
az extension add --name acrcssc

# Create patching workflow
az acr cssc workflow create \
  --registry myregistry \
  --name patch-workflow \
  --config-file config.json
```

See `continuous-patching` skill for details.

## Image Quarantine (Preview)

Gated workflow for external scanning:

### Enable Quarantine
```bash
az acr config quarantine update \
  --registry myregistry \
  --status enabled
```

### Quarantine Roles
| Role | Purpose |
|------|---------|
| `AcrQuarantineReader` | Read quarantined images |
| `AcrQuarantineWriter` | Release images from quarantine |

### Workflow
1. Image pushed → Quarantine state
2. External scanner analyzes image
3. Webhook notifies scanner
4. Scanner releases or blocks image

### Release from Quarantine
```bash
# Using quarantine API
PATCH /acr/v1/<repo>/_manifests/<digest>
{
  "quarantineState": "Passed",
  "quarantineDetails": "{...scan results...}"
}
```

## Remediation Strategies

### 1. Rebuild with Updated Base
```bash
# Use Defender recommendations
# Update Dockerfile FROM to patched base
docker build -t myapp:v2 .
```

### 2. Continuous Patching
```bash
# Automated OS patching
az acr cssc workflow create ...
```

### 3. Manual Package Updates
```dockerfile
# In Dockerfile
RUN apt-get update && apt-get upgrade -y
```

## Best Practices

1. **Scan on Push**: Enable Defender for all registries
2. **Block Critical**: Use quarantine or Policy for critical CVEs
3. **Automate Patching**: Use continuous patching for OS vulnerabilities
4. **Monitor Findings**: Set up alerts for new vulnerabilities
5. **Update Base Images**: Regularly rebuild with latest base images

## Severity Levels

| Level | Action |
|-------|--------|
| Critical | Immediate remediation |
| High | Remediate within 7 days |
| Medium | Plan remediation |
| Low | Track, remediate opportunistically |

## Integration with CI/CD

### GitHub Actions
```yaml
- name: Scan image
  uses: Azure/container-scan@v0
  with:
    image-name: myregistry.azurecr.io/myapp:${{ github.sha }}
```

### Azure DevOps
```yaml
- task: ContainerScan@0
  inputs:
    imageName: 'myregistry.azurecr.io/myapp:$(Build.BuildId)'
```

## Reference Documentation

- **Investigation reports**: `agent-investigation-reports/acr-features/vulnerability-scanning/`
- **MS Learn docs**: `azure-management-docs/articles/container-registry/scan-images-defender.md`
