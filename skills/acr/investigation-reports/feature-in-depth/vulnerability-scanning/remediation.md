# ACR Vulnerability Remediation Guide

## Overview

This guide covers remediation strategies for vulnerabilities detected in Azure Container Registry images, including automated remediation via Continuous Patching and manual remediation workflows.

---

## Remediation Approaches

### 1. Automated Remediation with Continuous Patching

**Best for**: OS-level vulnerabilities in Linux container images

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/key-concept-continuous-patching.md`

#### How It Works

1. **Detection**: Trivy scans images for OS-level vulnerabilities (CVEs)
2. **Patching**: Copa applies security fixes to vulnerable packages
3. **Output**: New tagged image with patches applied (e.g., `image:tag-1` or `image:tag-patched`)

#### Supported Vulnerability Types

| Type | Patchable | Notes |
|------|-----------|-------|
| OS system packages (apt, yum) | Yes | Fully automated |
| Application packages (Go, Python, NodeJS) | No | Requires rebuild |
| Custom application code | No | Requires developer fix |

#### Configuration Example

```json
{
    "version": "v1",
    "tag-convention": "incremental",
    "repositories": [
        {
            "repository": "myapp",
            "tags": ["*"],
            "enabled": true
        }
    ]
}
```

```bash
az acr supply-chain workflow create \
    -r myRegistry \
    -g myResourceGroup \
    -t continuouspatchv1 \
    --config ./continuouspatching.json \
    --schedule 1d \
    --run-immediately
```

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/how-to-continuous-patching.md` (lines 109-111)

---

### 2. Microsoft Defender Remediation Workflow

**Best for**: All vulnerability types with guided remediation

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/scan-images-defender.md`

#### Remediation Steps

1. **Review Findings**: Navigate to Microsoft Defender for Cloud dashboard
2. **Follow Recommendations**: Apply suggested remediation steps
3. **Replace Image**: Push the fixed image to the registry
4. **Verify**: Defender automatically rescans to confirm remediation

> After you've taken the recommended steps to remediate the security issue, replace the image in your registry. Microsoft Defender for Cloud rescans the image to confirm that the vulnerabilities are remediated.

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/scan-images-defender.md` (lines 23-24)

---

### 3. Quarantine-Based Remediation

**Best for**: Preventing vulnerable images from being deployed

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/preview/quarantine/readme.md`

#### Workflow

1. **Image Pushed**: Image enters quarantine state automatically
2. **Scanner Notified**: Quarantine webhook triggers scanner
3. **Scanner Pulls Image**: Using AcrQuarantineReader credentials
4. **Scan Performed**: External scanner analyzes the image
5. **Decision Made**:
   - **Passed**: Scanner updates state, image becomes available
   - **Failed**: Image remains quarantined, requires remediation

#### Updating Quarantine State After Remediation

```bash
# API endpoint
PATCH https://[registry].azurecr.io/acr/v1/[image]/_manifests/[digest]

# Payload for passed scan
{
    "quarantineState": "Passed",
    "quarantineDetails": "{\"state\":\"scan passed\",\"link\":\"http://results.io/report\"}"
}

# Payload for failed scan
{
    "quarantineState": "Failed",
    "quarantineDetails": "{\"state\":\"vulnerabilities found\",\"link\":\"http://results.io/report\"}"
}
```

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/preview/quarantine/readme.md` (lines 164-189)

---

### 4. Manual Remediation Strategies

#### Strategy A: Rebuild from Updated Base Image

1. Update Dockerfile to use patched base image
2. Rebuild the container image
3. Push to registry
4. Verify with Defender scan

```dockerfile
# Update base image to latest patched version
FROM mcr.microsoft.com/dotnet/aspnet:6.0-alpine3.18
```

#### Strategy B: Update Packages in Dockerfile

1. Add package update commands to Dockerfile
2. Rebuild and push

```dockerfile
FROM ubuntu:22.04

# Update and upgrade packages
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
    your-packages && \
    rm -rf /var/lib/apt/lists/*
```

#### Strategy C: Multi-Stage Build with Security Scan

1. Build application in one stage
2. Copy to minimal, updated runtime image
3. Reduces attack surface

```dockerfile
# Build stage
FROM node:18 AS builder
WORKDIR /app
COPY . .
RUN npm ci && npm run build

# Production stage - minimal image
FROM node:18-alpine AS production
WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/package*.json ./
RUN npm ci --only=production
CMD ["node", "dist/index.js"]
```

---

## Remediation by Vulnerability Type

### Critical Vulnerabilities

**Response Time**: Immediate

1. Stop using affected images in production if possible
2. Apply emergency patches or use alternative base image
3. Use Continuous Patching with `--run-immediately` flag
4. Monitor Defender dashboard for confirmation

### High Vulnerabilities

**Response Time**: Within 24-48 hours

1. Prioritize in patching schedule
2. Enable Continuous Patching if not already active
3. Track remediation in Defender for Cloud

### Medium/Low Vulnerabilities

**Response Time**: Regular patching cycle

1. Include in scheduled maintenance
2. Let Continuous Patching handle automatically
3. Review periodically for any escalation

---

## Remediation Troubleshooting

### Continuous Patching Issues

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/how-to-continuous-patching.md` (lines 171-225)

#### List Failed Tasks

```bash
az acr task list-runs -r registryname -n cssc-patch-image --run-status Failed --top 10
```

#### View Task Logs

```bash
az acr task logs -r registryname --run-id <run-id>
```

#### Cancel Misconfigured Workflow

```bash
az acr supply-chain workflow cancel-run \
    -r registryname \
    -g resourcegroup \
    --type continuouspatchv1
```

### Common Patching Failures

| Issue | Cause | Resolution |
|-------|-------|------------|
| EOSL image skipped | OS no longer supported | Upgrade base OS version |
| Patch task failed | Copa compatibility issue | Check logs, report to ACR team |
| No vulnerabilities patched | Only app-level CVEs found | Rebuild from source |

---

## Best Practices for Vulnerability Remediation

### 1. Layer Your Defenses

```
[Defender Detection] --> [Continuous Patching] --> [Quarantine Gating] --> [Production]
```

### 2. Use Tagging Strategy

- **Incremental** (`-1`, `-2`): For environments requiring rollback capability
- **Floating** (`-patched`): For CI/CD pipelines with auto-updates

### 3. Automate Where Possible

```bash
# Schedule daily patching
az acr supply-chain workflow create \
    -r myRegistry \
    -g myResourceGroup \
    -t continuouspatchv1 \
    --config ./config.json \
    --schedule 1d
```

### 4. Monitor and Alert

- Enable resource logs for registry
- Set up alerts on Defender findings
- Monitor patching task failures

### 5. Document Exemptions

For vulnerabilities that cannot be immediately fixed:
- Document the CVE and reason for exemption
- Set review dates
- Implement compensating controls

---

## Integration with CI/CD Pipelines

### Pre-Deployment Scanning

```yaml
# Azure DevOps example
- task: Docker@2
  inputs:
    containerRegistry: 'acr-connection'
    repository: 'myapp'
    command: 'build'
    Dockerfile: '**/Dockerfile'

# Scan before push
- script: |
    # Wait for Defender scan after push
    # Check scan results via API or CLI
```

### Post-Deployment Verification

```bash
# Verify image is not quarantined
az acr repository show-manifests \
    --name myregistry \
    --repository myapp \
    --query "[?quarantineState!='Passed']"
```

---

## Emergency Response Checklist

### When Critical CVE Announced

- [ ] Check if affected images are in your registry
- [ ] Enable/trigger Continuous Patching immediately
- [ ] If not patchable, identify alternative base images
- [ ] Communicate with development teams
- [ ] Update CI/CD pipelines to use patched images
- [ ] Verify remediation with Defender rescan
- [ ] Document incident and response

### Contact for Persistent Issues

For continuous patching issues that cannot be resolved:
> If the logs aren't sufficient, or an issue is persistent, or for any feedback, please email the ACR team at acr-patching-preview@microsoft.com

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/preview/continuous-patching/README.md` (line 322)

---

## References

- Defender remediation: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/scan-images-defender.md`
- Continuous Patching: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/how-to-continuous-patching.md`
- Key concepts: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/key-concept-continuous-patching.md`
- Quarantine pattern: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/preview/quarantine/readme.md`
- ACR preview continuous patching: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/preview/continuous-patching/README.md`
- Public content management: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/container-registry-consuming-public-content.md`
