# ACR Vulnerability Scanning Setup Guide

## Overview

This guide covers setup procedures for all vulnerability scanning options in Azure Container Registry, including Microsoft Defender for Cloud, Continuous Patching, and the Image Quarantine pattern.

---

## 1. Microsoft Defender for Cloud Setup

### Prerequisites

- Azure subscription with appropriate permissions
- Azure Container Registry (any SKU)
- Microsoft Defender for Cloud access

### Enabling Defender for Container Registries

Microsoft Defender for container registries is enabled at the subscription level:

1. Navigate to **Microsoft Defender for Cloud** in Azure Portal
2. Go to **Environment settings**
3. Select your subscription
4. Enable **Containers** plan

Once enabled, Defender automatically scans:
- Images pushed to the registry
- Images imported into the registry
- Images pulled within the last 30 days

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/scan-images-defender.md` (lines 14-21)

### Configuring Trusted Services for Network-Restricted Registries

If your registry has network restrictions, enable trusted services access:

**Azure CLI:**
```bash
# Enable trusted services
az acr update --name myregistry --allow-trusted-services true

# Verify setting
az acr show --name myregistry --query networkRuleSet.defaultAction
```

**Azure Portal:**
1. Navigate to your container registry
2. Under **Settings**, select **Networking**
3. Under **Firewall exception**, check **Allow trusted Microsoft services to access this container registry**
4. Select **Save**

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/allow-access-trusted-services.md` (lines 51-79)

---

## 2. Continuous Patching Setup

### Prerequisites

- Azure CLI version 2.15.0 or later
- Existing Resource Group with Azure Container Registry
- ACR with Tasks enabled (not available in free tier)
- Azure subscription NOT on "Free Trial" credits

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/how-to-continuous-patching.md` (lines 15-19)

### Step 1: Install the CLI Extension

```bash
az extension add -n acrcssc
```

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/how-to-continuous-patching.md` (lines 21-25)

### Step 2: Login to Azure and ACR

```bash
# Login to Azure
az login

# Login to your registry
az acr login -n myRegistry
```

### Step 3: Create Configuration File

Create a file named `continuouspatching.json`:

```json
{
    "version": "v1",
    "tag-convention": "incremental",
    "repositories": [
        {
            "repository": "python",
            "tags": ["*"],
            "enabled": true
        },
        {
            "repository": "ubuntu",
            "tags": ["jammy-20240111", "jammy-20240125"],
            "enabled": true
        }
    ]
}
```

**Configuration Schema:**

| Field | Description | Values |
|-------|-------------|--------|
| `version` | Schema version (don't change) | `"v1"` |
| `tag-convention` | Tagging approach for patched images | `"incremental"` or `"floating"` |
| `repositories` | Array of repository configurations | See below |
| `repository` | Repository name | String |
| `tags` | Tags to patch (`*` for all) | Array of strings |
| `enabled` | Enable/disable patching | `true` or `false` |

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/how-to-continuous-patching.md` (lines 41-85)

### Step 4: Test with Dry Run

```bash
az acr supply-chain workflow create \
    -r myRegistry \
    -g myResourceGroup \
    -t continuouspatchv1 \
    --config ./continuouspatching.json \
    --schedule 1d \
    --dry-run
```

The dry run outputs all artifacts that match your configuration criteria.

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/how-to-continuous-patching.md` (lines 87-98)

### Step 5: Create the Workflow

```bash
az acr supply-chain workflow create \
    -r myRegistry \
    -g myResourceGroup \
    -t continuouspatchv1 \
    --config ./continuouspatching.json \
    --schedule 1d \
    --run-immediately
```

**Schedule Parameter:**
- Minimum: 1 day (`1d`)
- Maximum: 30 days (`30d`)
- Resets on the 1st of each month

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/how-to-continuous-patching.md` (lines 100-113)

### Viewing Workflow Tasks

**Azure Portal:**
1. Navigate to your registry
2. Under **Services**, select **Repositories**
3. View `csscpolicies/patchpolicy` repository
4. Under **Services**, select **Tasks** to see:
   - `cssc-trigger-workflow`
   - `cssc-scan-image`
   - `cssc-patch-image`

**Azure CLI:**
```bash
az acr supply-chain workflow show \
    -r myRegistry \
    -g myResourceGroup \
    -t continuouspatchv1
```

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/how-to-continuous-patching.md` (lines 115-145)

### Updating the Workflow

```bash
az acr supply-chain workflow update \
    -r myRegistry \
    -g myResourceGroup \
    -t continuouspatchv1 \
    --config ./continuouspatching.json \
    --schedule 7d
```

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/how-to-continuous-patching.md` (lines 147-156)

### Deleting the Workflow

```bash
az acr supply-chain workflow delete \
    -r myregistry \
    -g myresourcegroup \
    -t continuouspatchv1
```

This automatically deletes:
- The `csscpolicies/patchpolicy` repository
- All three workflow tasks
- Any queued runs

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/how-to-continuous-patching.md` (lines 157-166)

---

## 3. Image Quarantine Setup (Preview)

### Prerequisites

- Azure Container Registry
- Service principal with appropriate roles
- Webhook endpoint for notifications

### Step 1: Enable Quarantine on Registry

```bash
# Get registry ID
id=$(az acr show --name myregistry --query id -o tsv)

# Enable quarantine
az resource update --ids $id --set properties.policies.quarantinePolicy.status=enabled

# To disable later
az resource update --ids $id --set properties.policies.quarantinePolicy.status=disabled
```

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/preview/quarantine/readme.md` (lines 42-50)

### Step 2: Create Quarantine Webhook

Subscribe to the "quarantine" webhook to receive notifications when images are pushed:

Use the [Management Webhook API](https://docs.microsoft.com/en-us/rest/api/containerregistry/webhooks/create) with the "quarantine" action.

**Webhook Payload Example:**
```json
{
  "id": "0d799b14-404b-4859-b2f6-50c5ee2a2c3a",
  "timestamp": "2018-02-28T00:42:54.4509516Z",
  "action": "quarantine",
  "target": {
    "size": 1791,
    "digest": "sha256:91ef6",
    "length": 1791,
    "repository": "helloworld",
    "tag": "1"
  },
  "request": {
    "id": "978fc988-zzz-yyyy-xxxx-4f6e331d1591",
    "host": "[registry].azurecr.io",
    "method": "PUT"
  }
}
```

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/preview/quarantine/readme.md` (lines 9-31)

### Step 3: Configure Scanner Service Principal

Create or configure a service principal with the following roles:

| Role | Purpose |
|------|---------|
| AcrQuarantineReader | Pull quarantined images for scanning |
| AcrQuarantineWriter | Update quarantine state after scanning |

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/roles-and-permissions.md` (lines 6-15)

### Step 4: Pull and Scan Quarantined Images

```bash
# Login with scanner credentials
docker login ${REGISTRY_NAME} -u [quarantinedServicePrincipalUsr] -p [quarantinedServicePrincipalPwd]

# Pull quarantined image by digest
docker pull [registry].azurecr.io/helloworld@sha256:80f0d5cxxxxXxxXxxxxece0db56d11cdc624ad20da9fe62d7d
```

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/preview/quarantine/readme.md` (lines 97-110)

### Step 5: Update Quarantine State

After scanning, update the manifest attributes:

**API Endpoint:**
```
PATCH https://[login-url]/acr/v1/[image]/_manifests/[digest]
```

**Payload:**
```json
{
    "quarantineState": "Passed",
    "quarantineDetails": "{\"state\":\"scan passed\",\"link\":\"http://test.io/test\"}"
}
```

**Quarantine States:**
- `Passed` - Image approved, triggers "push" webhook
- `Failed` - Image rejected, remains quarantined

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/preview/quarantine/readme.md` (lines 149-189)

### Quarantine Details Schema

The `quarantineDetails` field follows this schema:

```json
{
  "scanner": "SecurityCenter",
  "state": "ScanState",
  "link": "https://testresult/summary",
  "result": {
    "version": "0.0.1",
    "summary": [
      {"severity": "Critical", "count": 10},
      {"severity": "High", "count": 10},
      {"severity": "Low", "count": 10}
    ]
  }
}
```

**Severity Levels:** Critical, High, Medium, Low, None

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/preview/quarantine/quarantine-details/schema.json` and `example.json`

---

## 4. Gated Import Workflow (Advanced)

For comprehensive public content management with validation:

### Overview

This workflow:
1. Imports public images to a staging registry
2. Runs security scans and functional tests
3. Promotes approved images to production registries

### Example Test Script

```bash
#!/bin/bash
if [ "$(echo $BACKGROUND_COLOR | tr '[:lower:]' '[:upper:]')" = 'RED' ]; then
    echo -e "\e[31mERROR: Invalid Color:\e[0m" ${BACKGROUND_COLOR}
    EXIT_CODE=1
else
    echo -e "\e[32mValidation Complete - No Known Errors\e[0m"
fi
exit ${EXIT_CODE}
```

### ACR Task YAML for Gated Import

```yaml
version: v1.1.0
steps:
  - id: build-test-base-image
    build: >
      --build-arg REGISTRY_FROM_URL={{.Values.REGISTRY_FROM_URL}}
      -f ./Dockerfile
      -t {{.Run.Registry}}/node-import:test
      .
  - id: validate-base-image
    when: ['build-test-base-image']
    cmd: "{{.Run.Registry}}/node-import:test"
  - id: pull-base-image
    when: ['validate-base-image']
    cmd: >
        docker pull {{.Values.REGISTRY_FROM_URL}}node:15-alpine
  - id: push-base-image
    when: ['pull-base-image']
    push:
    - "{{.Run.Registry}}/node:15-alpine"
```

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/container-registry-consuming-public-content.md` (lines 431-504)

---

## Summary of Setup Requirements

| Feature | Prerequisites | CLI Extension | SKU Requirement |
|---------|---------------|---------------|-----------------|
| Microsoft Defender | Defender subscription | None | Any |
| Continuous Patching | ACR Tasks enabled | `acrcssc` | Basic+ (not free) |
| Image Quarantine | Service principal | None | Any |
| Gated Import | ACR Tasks, Key Vault | None | Basic+ |

## References

- Defender setup: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/scan-images-defender.md`
- Continuous Patching setup: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/how-to-continuous-patching.md`
- Quarantine pattern: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/preview/quarantine/readme.md`
- Gated import workflow: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/container-registry-consuming-public-content.md`
- Roles and permissions: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/roles-and-permissions.md`
