# ACR Vulnerability Scanning - Investigation Findings

## Key Findings Summary

This document consolidates all findings from the investigation of ACR vulnerability scanning capabilities across both submodules.

---

## Finding 1: Multiple Scanning Solutions Available

### Microsoft Defender for Cloud (Primary)

**Location**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/scan-images-defender.md`

Key capabilities:
- Subscription-level enablement
- Automatic scanning on push, import, and recent pulls
- Trusted service access to network-restricted registries
- Integrated remediation recommendations

**FAQ Confirmation** (line 30-32 of `container-registry-faq.yml`):
```yaml
question: |
  Is there security vulnerability scanning for images in ACR?
answer: |
  Yes. You can use [Microsoft Defender for Containers] or other solutions, such as [Aqua].
```

### Continuous Patching (Native ACR Feature)

**Locations**:
- MS Learn: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/key-concept-continuous-patching.md`
- ACR Repo: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/preview/continuous-patching/README.md`

Key capabilities:
- Uses Trivy for scanning, Copa for patching
- OS-level vulnerability remediation only
- Automated scheduling (1-30 days)
- No source code access required

### Image Quarantine Pattern (Preview)

**Location**: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/preview/quarantine/readme.md`

Key capabilities:
- Pre-approval gating for pushed images
- Webhook-based scanner integration
- Role-based quarantine access (AcrQuarantineReader/Writer)
- Structured scan result storage

---

## Finding 2: Continuous Patching Limitations

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/key-concept-continuous-patching.md` (lines 26-36)

| Limitation | Description |
|------------|-------------|
| Windows images | Not supported |
| Application vulnerabilities | Go, Python, NodeJS packages cannot be patched |
| EOSL images | End of Service Life images are skipped |
| Multi-arch images | Not supported |
| Image limit | Maximum 100 images per registry |
| ABAC incompatibility | Cannot use with ABAC-enabled registries |
| PTC incompatibility | Cannot use with Pull Through Cache rules |
| Free trial | Not supported on free trial subscriptions |

---

## Finding 3: Tagging Conventions for Patched Images

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/key-concept-continuous-patching.md` (lines 37-64)

### Incremental Tagging (Default)

- Pattern: `original-tag-N` (e.g., `python:3.11-1`, `python:3.11-2`)
- Suffixes `-1` to `-999` are patch tags
- Suffixes greater than `-999` are treated as original tags
- Best for: Auditability and rollback scenarios

### Floating Tagging

- Pattern: `original-tag-patched` (e.g., `python:3.11-patched`)
- Single mutable tag always points to latest patch
- Best for: CI/CD pipelines with automatic updates
- Drawback: Difficult to rollback

---

## Finding 4: Quarantine Roles and Permissions

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/roles-and-permissions.md` (lines 6-15)

| Role | ARM Access | Push | Pull | Change Quarantine | Pull Quarantine |
|------|------------|------|------|-------------------|-----------------|
| Owner | X | X | X | - | - |
| Contributor | X | X | X | - | - |
| Reader | X | - | X | - | - |
| AcrPush | - | X | X | - | - |
| AcrPull | - | - | X | - | - |
| **AcrQuarantineWriter** | - | - | - | **X** | **X** |
| **AcrQuarantineReader** | - | - | - | - | **X** |

**Important Note** (line 53-54):
> This role should only be assigned to vulnerability scanners using service principals. Individual users, even operations people should use the vulnerability scanning solution to override the quarantine state.

---

## Finding 5: Quarantine Details Schema

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/preview/quarantine/quarantine-details/schema.json`

The quarantine system uses a structured JSON schema for scan results:

```json
{
  "scanner": "string - name of the scanner",
  "state": "string - state of the scan result",
  "link": "string - link to the scan report",
  "result": {
    "version": "string (e.g., '0.0.1')",
    "summary": [
      {
        "severity": "Critical|High|Medium|Low|None",
        "count": "integer"
      }
    ],
    "description": "string (max 1024 chars)"
  }
}
```

---

## Finding 6: Trusted Services Architecture

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/allow-access-trusted-services.md` (lines 41-47)

Microsoft Defender for Cloud operates as a **trusted service**:
- Does NOT require managed identity configuration
- Does NOT require RBAC role assignment
- Automatically bypasses network rules when enabled
- Enabled by default in new registries

Other trusted services (requiring identity/RBAC):
- Azure Container Instances
- Machine Learning
- Azure Container Registry (for cross-registry imports)

---

## Finding 7: Continuous Patching Workflow Tasks

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/preview/continuous-patching/README.md` (lines 179-192)

Three ACR Tasks are created for the workflow:

| Task Name | Function |
|-----------|----------|
| `cssc-trigger-workflow` | Scans configuration, triggers scan task per image |
| `cssc-scan-image` | Scans image for OS vulnerabilities using Trivy |
| `cssc-patch-image` | Patches the image using Copa |

**Skip Conditions for Patching:**
1. No OS vulnerabilities found
2. Image is End of Service Life (EOSL)

---

## Finding 8: CLI Commands for Continuous Patching

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/how-to-continuous-patching.md`

| Command | Purpose |
|---------|---------|
| `az acr supply-chain workflow create` | Create patching workflow |
| `az acr supply-chain workflow show` | View workflow details |
| `az acr supply-chain workflow update` | Update workflow configuration |
| `az acr supply-chain workflow delete` | Delete workflow |
| `az acr supply-chain workflow list` | List task run statuses |
| `az acr supply-chain workflow cancel-run` | Cancel running tasks |

**Workflow List Output Fields:**
- Image name and tag
- Workflow type
- Scan status and date
- Scan task ID
- Patch status and date
- Patched image name + tag
- Patch task ID

---

## Finding 9: Network Considerations

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/includes/container-registry-scanning-limitation.md`

When public network access is disabled:
1. Trusted services (including Defender) require "Allow trusted Microsoft services" enabled
2. Azure DevOps Services may not access the registry
3. Azure DevOps requires self-hosted agents with network access to private endpoints
4. Portal listing of repositories/tags may be unavailable outside the VNet

---

## Finding 10: Integration with Other Security Features

### Content Trust / Signing

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/TOC.yml` (lines 232-252)

ACR vulnerability scanning complements:
- Notation-based image signing
- Artifact Signing integration
- Ratify verification in AKS
- Azure Policy enforcement

### Azure Policy Integration

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/container-registry-azure-policy.md`

Built-in policies for registry compliance:
- Network access restrictions
- CMK encryption requirements
- Admin account status

---

## Finding 11: Public Content Management

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/acr/docs/container-registry-consuming-public-content.md`

Recommended workflow for public images:
1. Import local copies of dependent public images
2. Validate through security scanning and functional testing
3. Promote to private registries for internal usage
4. Trigger base image updates for dependent applications

This "gated import" pattern prevents:
- Unexpected upstream changes breaking production
- Unvetted vulnerabilities entering the environment

---

## Finding 12: Documentation Coverage Comparison

### MS Learn Documentation (azure-management-docs)

| Topic | File |
|-------|------|
| Defender scanning | `scan-images-defender.md` |
| Continuous patching concepts | `key-concept-continuous-patching.md` |
| Continuous patching setup | `how-to-continuous-patching.md` |
| Trusted services | `allow-access-trusted-services.md` |
| Security controls | `security-controls-policy.md` |

### ACR GitHub Repository

| Topic | File |
|-------|------|
| Quarantine pattern | `docs/preview/quarantine/readme.md` |
| Quarantine schema | `docs/preview/quarantine/quarantine-details/schema.json` |
| Continuous patching (preview) | `docs/preview/continuous-patching/README.md` |
| Roles and permissions | `docs/roles-and-permissions.md` |
| Public content workflow | `docs/container-registry-consuming-public-content.md` |

---

## Key Observations

1. **Multiple Layers of Security**: ACR provides defense-in-depth with Defender scanning, native patching, quarantine gating, and signing/verification

2. **Automation Focus**: Both Defender and Continuous Patching emphasize automated, hands-off security maintenance

3. **Complementary Solutions**: Defender detects vulnerabilities; Continuous Patching remediates them automatically

4. **Preview Features**: Quarantine pattern and some continuous patching features are still in preview

5. **Network Compatibility**: All scanning solutions work with network-restricted registries when properly configured

6. **Role Separation**: Quarantine roles (AcrQuarantineReader/Writer) are specifically designed for scanner service principals, not human users
