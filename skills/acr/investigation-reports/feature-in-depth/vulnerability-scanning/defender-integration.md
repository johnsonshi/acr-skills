# Microsoft Defender for Cloud Integration with ACR

## Overview

Microsoft Defender for Cloud provides built-in vulnerability scanning capabilities for Azure Container Registry. This integration is the primary recommended method for scanning container images in ACR.

## How Defender Scanning Works

### Scanning Triggers

Microsoft Defender for Cloud automatically scans images in the following scenarios:

1. **Push Events**: When an image is pushed to the registry
2. **Import Events**: When an image is imported into the registry
3. **Recent Pull Events**: Any images pulled within the last 30 days

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/scan-images-defender.md` (line 21)

### Authentication and Access

- Defender for Cloud authenticates with the registry automatically
- Login events and image pull events are logged in registry resource logs
- Events are associated with alphanumeric IDs (e.g., `b21cb118-5a59-4628-bab0-3c3f0e434cg6`)

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/scan-images-defender.md` (lines 27-28)

## Trusted Service Configuration

### Network-Restricted Registries

Microsoft Defender for Cloud is listed as a **trusted service** and can access network-restricted registries:

| Trusted Service | Usage Scenario | Requires Managed Identity |
|-----------------|----------------|---------------------------|
| Microsoft Defender for Cloud | Vulnerability scanning | No |
| Azure Container Instances | Deploy from ACR | Yes |
| Machine Learning | Deploy/train models | Yes |
| Azure Container Registry | Import images | No |

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/allow-access-trusted-services.md` (lines 41-47)

### Enabling Trusted Services Access

By default, the "allow trusted services" setting is enabled in new registries. To manage this setting:

**Azure CLI - Disable:**
```bash
az acr update --name myregistry --allow-trusted-services false
```

**Azure CLI - Enable:**
```bash
az acr update --name myregistry --allow-trusted-services true
```

**Azure Portal:**
1. Navigate to your container registry
2. Under **Settings**, select **Networking**
3. Under **Firewall exception**, check/uncheck **Allow trusted Microsoft services to access this container registry**
4. Select **Save**

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/allow-access-trusted-services.md` (lines 51-79)

### Important Considerations for Network-Restricted Registries

When network rules are configured (public access disabled, IP rules configured, or private endpoints created):

- Ensure "Allow trusted Microsoft services" is enabled for Defender scanning to work
- Some functionality may be unavailable without additional configuration
- Azure DevOps Services require self-hosted agents with network access to private endpoints

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/includes/container-registry-scanning-limitation.md` (lines 14-20)

## Enabling Microsoft Defender for Containers

Microsoft Defender for container registries is enabled at the **subscription level**. Once enabled:

1. Images are automatically scanned on push, import, or recent pull
2. Vulnerabilities appear in Microsoft Defender for Cloud dashboard
3. Remediation recommendations are provided

For detailed enablement steps, refer to:
- [Microsoft Defender for container registries documentation](/azure/defender-for-cloud/defender-for-containers-va-acr)
- [Container security in Microsoft Defender for Cloud](/azure/defender-for-cloud/defender-for-containers-introduction)

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/scan-images-defender.md` (lines 14-17)

## Viewing and Remediating Findings

### Viewing Vulnerability Results

Scan results appear in Microsoft Defender for Cloud:
- Navigate to Microsoft Defender for Cloud in Azure Portal
- Review vulnerability findings for container images
- View severity ratings (Critical, High, Medium, Low)

### Remediation Workflow

1. Review recommended remediations in Microsoft Defender for Cloud
2. Take the recommended steps to fix security issues
3. Replace the vulnerable image in your registry
4. Microsoft Defender for Cloud automatically rescans to confirm remediation

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/scan-images-defender.md` (lines 21-25)

## Defender Integration with ACR Features

### Integration Points

| ACR Feature | Defender Integration |
|-------------|---------------------|
| Public registries | Automatic scanning |
| Private endpoint registries | Requires trusted services enabled |
| IP-restricted registries | Requires trusted services enabled |
| Geo-replicated registries | Scans in each region |

### Monitoring Defender Activity

Resource logs capture Defender activity:
- Registry login events
- Image pull events for scanning
- Events associated with Defender service principal IDs

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/scan-images-defender.md` (lines 27-28)

## FAQ Reference

From the ACR FAQ:

> **Question**: Is there security vulnerability scanning for images in ACR?
>
> **Answer**: Yes. You can use [Microsoft Defender for Containers](/azure/defender-for-cloud/defender-for-containers-introduction) or other solutions, such as [Aqua](https://www.aquasec.com/solutions/azure-container-security).

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/container-registry-faq.yml` (lines 30-32)

## Security Feature in ACR Intro

From the ACR introduction documentation:

> Microsoft Defender for Cloud optionally integrates with Azure Container Registry to [scan images](/azure/container-registry/scan-images-defender) whenever you push an image to a registry.

**Source**: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/container-registry-intro.md` (line 48)

## Best Practices

1. **Enable Defender at Subscription Level**: Ensure Microsoft Defender for Containers is enabled
2. **Keep Trusted Services Enabled**: For network-restricted registries, maintain the trusted services setting
3. **Monitor Resource Logs**: Review registry logs to track Defender scanning activity
4. **Act on Recommendations**: Regularly review and address vulnerability findings
5. **Combine with Continuous Patching**: Use Defender for detection and Continuous Patching for automated remediation

## References

- Main Defender scanning documentation: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/scan-images-defender.md`
- Trusted services configuration: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/allow-access-trusted-services.md`
- Network limitations: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/includes/container-registry-scanning-limitation.md`
- ACR Introduction (security features): `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/container-registry-intro.md`
- FAQ: `/Users/johnsonshi/repos/acr-skills/submodules/azure-management-docs/articles/container-registry/container-registry-faq.yml`
